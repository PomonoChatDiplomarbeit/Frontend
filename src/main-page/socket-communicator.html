<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<dom-module id="socket-communicator">
    <template>
    </template>

    <script>
        /**
     * `socket-communicator`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

        class SocketCommunicator extends Polymer.Element {
            static get is() { return 'socket-communicator'; }
            constructor() {
                super();
                this.connectToSocketIO();
            }
            connectedCallback() {
                this.connectToSocketIO();
            }
            connectToSocketIO() {
                if (!this.loggedin) {
                    this.socket = io.connect('http://127.0.0.1:3000/');
                    this.socket.on('login-response', data => { this.IOLoginResponse(data) });
                    this.socket.on('room-response', data => { this.IORoomPresponse(data) });
                    this.socket.on('reloadRooms', data => { this.IOreloadRooms(data) });
                    this.socket.on('createRoom-response', data => { this.IOreloadRooms(data) });
                    this.socket.on('messagesResponse', data => { this.IOmessagesResponse(data) });
                    this.socket.on('messageResponse', data => { this.IOmessageResponse(data.textToDisplay, data.status) });
                }
            }

            login() {
                if (!this.loggedin) {
                    this.socket.emit('login', this.user);
                    console.log('trying to login');
                }
            }
            getAllrooms() { 
                this.socket.emit('load rooms for user', this.user.username);
                console.log('socket io load rooms for user');
            }
            getAllMessagesForRoom() {
                this.socket.emit('getMessagesForChat', { user: this.username, partner: this.chatpartner });
                console.log('socket io getMessagesForChat');
            }
            emitMessage() {
                if (this.loggedin) {
                    //var toemit = new Message(this.user.username, 'text', this.message, 'now');
                    var toemit = {
                        sender: this.user.username,
                        type: "text",
                        data: this.message
                    };
                    this.socket.emit('add message to room', this.room._id, toemit);
                    console.log(toemit);
                }
            }
            createRoom(roomName, usernames) {
                if (this.loggedin) {
                    this.socket.emit('createNewRoom', roomName,usernames);
                    console.log('New Room created:' + roomName);
                }
            }
            IOLoginResponse(status) {
                console.log('login-status' + status)
                if (status == 'OK')
                    this.set('loggedin', true);
                else
                    this.set('loggedin', false);
                console.log(this.loggedin);
            }
            IORoomPresponse(allRooms) {
                //this.set('room', undefined);
                this.set('rooms', allRooms);
            }
            IOmessagesResponse(listOfMessages) {
                console.log('messages received for ' + this.chatpartner + ' count: ' + listOfMessages.length);
                this.allmessages = listOfMessages;
            }
            IOmessageResponse(message, status) {
                console.log('message: ' + message + ';server: ' + status);
                this.push('allmessages', new MessageObj(message, this.username, this.chatpartner))
                //this.allmessages.push();
                console.log(this.allmessages)
            }
            IOreloadRooms(){
                this.getAllrooms();
            }
            static get properties() {
                return {
                    message: {
                        type: String
                    },
                    allmessages: {
                        type: Array
                    },
                    room: {
                        type: String
                    },
                    availablerooms: {
                        type: Array
                    },
                    rooms: {
                        type: Array,
                        notify: true
                    },
                    user: {
                        type: Object
                    },
                    loggedin: {
                        type: Boolean,
                        value: false,
                        notify: true
                    }
                };
            }
        }

        window.customElements.define(SocketCommunicator.is, SocketCommunicator);
    </script>
</dom-module>