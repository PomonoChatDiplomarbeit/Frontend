<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<dom-module id="socket-communicator">
    <template>
    </template>

    <script>
        /**
     * `socket-communicator`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

        class SocketCommunicator extends Polymer.Element {
            static get is() { return 'socket-communicator'; }
            constructor() {
                super();
                this.connectToSocketIO();
            }
            connectedCallback() {
                this.connectToSocketIO();
            }
            connectToSocketIO() {
                if (!this.loggedin) {
                    this.socket = io.connect('http://127.0.0.1:3000/');
                    this.socket.on('login-response', data => { this.IOLoginResponse(data) });
                    this.socket.on('roomResponse', data => { this.IORoomPresponse(data) });
                    this.socket.on('messagesResponse', data => { this.IOmessagesResponse(data) });
                    this.socket.on('messageResponse', data => { this.IOmessageResponse(data.textToDisplay, data.status) });
                }
            }

            login() {
                if (!this.loggedin) {
                    this.socket.emit('login', this.user);
                    console.log('trying to login');
                }
            }
            getAllRooms() {
                //this.availablerooms = [];
                /*this.push('availablerooms',new Room('room 1', '1', [], [
                    new Message('Sandro', 'text', 'abc','8:56'),
                    new Message('Dragan', 'text', 'cde','8:57')
                ], 'S'));
                this.push('availablerooms',new Room('room 2', '2', [], [
                    new Message('sepi', 'text', 'abc','8:56'),
                    new Message('pepi', 'text', 'cde','8:57')
                ], 'S'));*/
                this.socket.emit('getAllRooms', this.user);
                console.log('socket io getallrooms');
            }
            getAllMessagesForRoom() {
                this.socket.emit('getMessagesForChat', { user: this.username, partner: this.chatpartner });
                console.log('socket io getMessagesForChat');
            }
            emitMessage() {
                if (this.loggedin) {
                    var toemit = new Message(this.user, 'text', this.message, 'now');
                    this.socket.emit('pushMessageRoom', this.room.id, toemit);
                    console.log(toemit);
                }
            }
            createRoom(roomName, usernames) {
                if (this.loggedin) {
                    this.socket.emit('createNewRoom', { roomName: roomName, usernames });
                    console.log('New Room created:' + roomName);
                }
            }
            IOLoginResponse(status) {
                console.log('login-status' + status)
                if (status == 'OK')
                    this.set('loggedin', true);
                else
                    this.set('loggedin', false);
                console.log(this.loggedin);
            }
            IORoomPresponse(allRooms) {
                //this.set('availablerooms', []);
                console.log("Rooms received count: " + allRooms.length);
                //console.log(allRooms);
                console.log(this.availablerooms);
                /*this.set('availablerooms', [
                    new Room('room 1', '1', [new User("Sandro")], [
                        new Message('Sandro', 'text', 'abc','8:56'),
                        new Message('Dragan', 'text', 'cde','8:57')
                    ], 'S'),
                    new Room('room 2', '2', [], [
                        new Message('sepi', 'text', 'abc','8:56'),
                        new Message('pepi', 'text', 'cde','8:57')
                    ], 'S')
                ]);*/
                this.set('availablerooms', []);
                this.set('availablerooms', allRooms);
                console.log(this.availablerooms);
                //this.notifyPath('availablerooms', allRooms);
                //this.message = 'ok';
                //console.log(this.availablerooms);    
            }
            IOmessagesResponse(listOfMessages) {
                console.log('messages received for ' + this.chatpartner + ' count: ' + listOfMessages.length);
                this.allmessages = listOfMessages;
            }
            IOmessageResponse(message, status) {
                console.log('message: ' + message + ';server: ' + status);
                this.push('allmessages', new MessageObj(message, this.username, this.chatpartner))
                //this.allmessages.push();
                console.log(this.allmessages)
            }
            static get properties() {
                return {
                    message: {
                        type: String
                    },
                    allmessages: {
                        type: Array
                    },
                    room: {
                        type: String
                    },
                    availablerooms: {
                        type: Array
                    },
                    user: {
                        type: Object
                    },
                    loggedin: {
                        type: Boolean,
                        value: false,
                        notify: true
                    }
                };
            }
        }

        window.customElements.define(SocketCommunicator.is, SocketCommunicator);
    </script>
</dom-module>