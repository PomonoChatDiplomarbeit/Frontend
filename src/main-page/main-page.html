<script src="../../bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<!--<script src="./serverCommunication.js/"></script>-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="./pomono-message.html">
<link rel="import" href="./pomono-login-popup.html">

<dom-module id="main-page">
  <template>
    <style is="custom-style"> 
        :host {
          display: block;
          padding: 10px;
        }
        paper-button {
          font-family: 'Roboto', 'Noto', sans-serif;
          font-weight: normal;
          font-size: 14px;
          -webkit-font-smoothing: antialiased;
        }
        paper-button.indigo {
          background-color: var(--paper-indigo-500);
          color: white;
          --paper-button-raised-keyboard-focus: {
            background-color: var(--paper-pink-a200) !important;
            color: white !important;
          };
        }
        html, body {
        margin: 0;
          font-family: 'Roboto', 'Noto', sans-serif;
          -webkit-font-smoothing: antialiased;
          background-color: #FFCCBC;
          max-height: 368px;
        }
        app-toolbar {
          background-color: #E64A19;
          color: #fff;
        }

        paper-icon-button {
          --paper-icon-button-ink-color: white;
        }

        paper-icon-button + [main-title] {
          margin-left: 24px;
        }
        app-header {
          @apply --layout-fixed-top;
          color: #fff;
          --app-header-background-rear-layer: {
            background-color: #ef6c00;
          };
        }
        app-drawer {
          --app-drawer-scrim-background: rgba(0, 0, 100, 0.8);
          --app-drawer-content-container: {
            background-color: #00BCD4;
          }
        }
        #centerPanel {
          min-height: 100%;
        }
        .chatPartnerDrawer {
          background-color: lightseagreen;
        }
    </style>
<!-- include="shared-styles" -->
   <pomono-login-popup id="popup"></pomono-login-popup>
   <app-drawer-layout>
     <app-drawer id="drawer" swipe-open slot="drawer">
       <paper-icon-button id="openlogin" icon="account-circle"></paper-icon-button>
        <paper-listbox id="allChats" selected="{{selectedID}}" fallback-selection="0">
          <template is="dom-repeat" items="{{availableChatPartners}}">
              <paper-item class="chatPartnerDrawer"><paper-button>{{item}}</paper-button></paper-item>
              <!--<paper-button>{{item}}</paper-button>-->
          </template>
        </paper-listbox>
      </app-drawer>
      <app-header-layout>
        <app-header slot="header">
          <app-toolbar>
            <paper-icon-button id="menutoggle" icon="menu"></paper-icon-button>
            <div main-title>{{chatPartner}}</div>
            <paper-icon-button icon="search"></paper-icon-button>
          </app-toolbar>
        </app-header>
        <div id="centerPanel">
            <div class="my-content-wrapper">
              <div id="listOfMessages" role="listbox">
                <template is="dom-repeat" items="{{allmessages}}">
                  <pomono-message contact="{{item.sender}}" messagetext="{{item.text}}" ></pomono-message>
                </template>
              </div>
            </div>
            <div id="submissionBlock">
              <paper-input id="message" label="Message" value="{{message}}">
                <iron-icon icon="mail" slot="prefix"></iron-icon>
                <paper-icon-button id="sendMessage" slot="suffix" icon="send"></paper-icon-button>
              </paper-input>
            </div>
        </div>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    //todo: alle Klassen auslagern
      class Communicator {
        getMessagesForChat(chatPartnerName) {
            console.log('partner: ' + chatPartnerName);
            return  [
                        new MessageObj("Nachricht 1", chatPartnerName, "Fabian"),
                        new MessageObj("Nachricht 2", chatPartnerName, "Fabian")
                    ];
        }
       
        anotherStaticMethod() {
            return this.staticMethod() + ' from another static method';
        }
        getAllChatPartners() {
          return [
              "Dragan",
              "Sandro",
              "Tschofe"
          ];
        }
      }
     class MessageObj{
        constructor(text, sender, receiver) {
            this.text = text;
            this.sender = sender;
            this.receiver = receiver;
        }
    }
    class MainPage extends Polymer.Element {
      static get is() { return 'main-page'; }
       ready() {
            super.ready();
            this.$.sendMessage.addEventListener('click', e => {this._handleClick(e)});
            this.$.menutoggle.addEventListener('click',  e => {this._toggleDrawer(e)});
            this.$.openlogin.addEventListener('click',  e => {this._openLogin(e)});
            //this.$.dialog.open();

            this._openLogin();
            this._loadAllChatPartners();
        }
        _openLogin(e) {
          this.$.popup.opened = true;
        }
        _handleClick(e) {
          if(this.message!=undefined&&this.message!=""){
            this.push('allmessages', new MessageObj(this.message, "Fabian", this.chatPartner));
            console.info('Message:' + this.message);
          }
        }
        _chatPartnerChanged(){
          console.log('Messages loaded for ' + this.chatPartner);
           this.allmessages = this.communicator.getMessagesForChat(this.chatPartner);
        }
        _toggleDrawer(e) {
            console.log("Drawer toggled!");
            this.$.drawer.toggle();
        }
        _computeSelectedItem(selectedID) { 
          this.message = "";
          this._toggleDrawer();
          return this.availableChatPartners[selectedID];
        }
        _loadAllChatPartners(){
            this.availableChatPartners = this.communicator.getAllChatPartners();
        }
        static get properties() {
            return {
                greeting : {
                    type: String,
                    value: "Hello!"
                },
                message : {
                    type: String,
                    value: ""
                },
                allmessages : {
                    type: Array,
                    value: []
                },
                chatPartner : {
                    type: String,
                    computed: '_computeSelectedItem(selectedID)',
                    observer: '_chatPartnerChanged'
                },
                availableChatPartners : {
                    type: Array,
                    value: []
                },
                communicator : {
                  type: Object,
                  value: new Communicator()
                }
            }
        }
    }

    window.customElements.define(MainPage.is, MainPage);
  </script>
</dom-module>
